<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Convo Academy — IDE (Fixed)</title>
  <style>
    :root{--blue:#004aad;--light:#e6f0ff;--accent:#66a6ff}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; padding:20px; background:linear-gradient(135deg,#89f7fe,#66a6ff); color:#002a4e}
    .wrap{max-width:1100px;margin:0 auto}
    header{background:var(--blue);color:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12);text-align:center}
    header h1{margin:0;font-size:1.6rem}
    main{display:flex;gap:20px;margin-top:18px;flex-wrap:wrap}
    .editor, .preview{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 16px rgba(0,0,0,0.08)}
    .editor{flex:1 1 520px;min-height:380px;display:flex;flex-direction:column}
    .editor label{font-weight:600;margin-bottom:8px}
    textarea{flex:1;resize:vertical;padding:12px;border-radius:8px;border:1px solid #cce0ff;font-family:monospace;font-size:14px;line-height:1.5;min-height:260px}
    .controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 6px 12px rgba(0,75,165,0.25)}
    button.secondary{background:#888}
    button.ghost{background:transparent;color:var(--blue);box-shadow:none;border:2px solid rgba(0,0,0,0.06)}
    .preview{flex:1 1 480px;min-height:380px;display:flex;flex-direction:column}
    .preview .label{font-weight:700;color:var(--blue);margin-bottom:8px}
    iframe{flex:1;border-radius:8px;border:1px solid #e6eefc}
    .status{margin-top:10px;min-height:28px;color:#b00020;font-weight:700}
    footer{margin-top:18px;text-align:center;color:#002a4e}
    @media (max-width:980px){main{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Convo Academy — IDE (Fixed)</h1>
      <div style="font-size:0.95rem;margin-top:6px;opacity:0.95">Click <strong>Run</strong> to preview your HTML. Use <kbd>Ctrl/⌘ + Enter</kbd> to run quickly.</div>
    </header>

    <main>
      <section class="editor" aria-label="Code editor">
        <label for="codeEditor">Your HTML / CSS / JS</label>
        <textarea id="codeEditor" spellcheck="false" aria-multiline="true"><!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>My Project</title>
</head>
<body>
  <h2>Hello, Convo Academy!</h2>
  <p>Edit this and press Run.</p>
</body>
</html>
        </textarea>

        <div class="controls">
          <button id="runBtn" title="Run (Ctrl/⌘ + Enter)">Run</button>
          <button id="openBtn" class="secondary" title="Open preview in a new tab">Open in new tab</button>
          <button id="downloadBtn" class="secondary" title="Download current code as HTML">Download</button>
          <button id="sampleBtn" class="ghost" title="Load a short sample">Load sample</button>
        </div>

        <div id="status" class="status" aria-live="polite" style="display:none"></div>
      </section>

      <section class="preview" aria-label="Preview">
        <div class="label">Live Preview</div>
        <iframe id="previewFrame" title="Preview frame"></iframe>
        <div style="font-size:0.9rem;margin-top:8px;color:#0b3;">Tip: JavaScript runtime errors are shown below.</div>
        <div id="errorBox" style="color:#b00020;font-weight:700;margin-top:8px;min-height:22px"></div>
      </section>
    </main>

    <footer>
      Tested to work on desktop & mobile. If something still fails, tell me what browser & device you're using.
    </footer>
  </div>

  <script>
    (function(){
      const editor = document.getElementById('codeEditor');
      const preview = document.getElementById('previewFrame');
      const runBtn = document.getElementById('runBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const openBtn = document.getElementById('openBtn');
      const sampleBtn = document.getElementById('sampleBtn');
      const status = document.getElementById('status');
      const errorBox = document.getElementById('errorBox');

      function makeWrapper(userCode){
        // We inject a small script that forwards runtime errors to the parent via postMessage
        return '<!doctype html><html><head><meta charset="utf-8"></head><body>' + userCode + '\n' +
          '<script>\n' +
          '  window.addEventListener("error", function(e){\n' +
          '    try{ parent.postMessage({__convoIDE:true, type:"error", message:e.message, filename:e.filename, lineno:e.lineno, colno:e.colno}, "*"); } catch(_){}\n' +
          '  });\n' +
          '  window.addEventListener("unhandledrejection", function(e){\n' +
          '    try{ parent.postMessage({__convoIDE:true, type:"rejection", message:(e.reason && e.reason.message) ? e.reason.message : String(e.reason)}, "*"); } catch(_){}\n' +
          '  });\n' +
          '<\/script>\n' +
          '</body></html>';
      }

      function updatePreview(){
        errorBox.textContent = '';
        status.style.display = 'none';
        const code = editor.value;
        try{
          preview.srcdoc = makeWrapper(code);
        } catch(err){
          status.style.display = '';
          status.textContent = 'Preview failed: ' + err.message;
        }
      }

      // PostMessage listener to receive errors from iframe
      window.addEventListener('message', (ev) => {
        try{
          const d = ev.data;
          if(d && d.__convoIDE){
            errorBox.textContent = (d.type || 'ERROR') + ': ' + (d.message || 'Unknown');
            // show details briefly
            status.style.display = '';
            status.textContent = 'Runtime ' + (d.type || 'error') + (d.filename ? ' — ' + d.filename : '') + (d.lineno ? ':' + d.lineno : '');
          }
        } catch(_){ /* ignore */ }
      });

      // Buttons
      runBtn.addEventListener('click', updatePreview);
      editor.addEventListener('keydown', function(e){ if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ e.preventDefault(); updatePreview(); } });

      downloadBtn.addEventListener('click', function(){
        const blob = new Blob([editor.value], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'project.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      openBtn.addEventListener('click', function(){
        const wrapper = makeWrapper(editor.value);
        // Use data URL to open in new tab
        try{
          const newWin = window.open();
          if(!newWin){ status.style.display=''; status.textContent='Popup blocked — allow popups for this site.'; return; }
          newWin.document.open(); newWin.document.write(wrapper); newWin.document.close();
        } catch(err){
          status.style.display=''; status.textContent='Could not open new tab: ' + err.message;
        }
      });

      sampleBtn.addEventListener('click', function(){
        editor.value = '<!doctype html>\n<html>\n<head>\n  <meta charset="utf-8">\n  <title>Sample</title>\n  <style>body{font-family:Arial;padding:20px}</style>\n</head>\n<body>\n  <h2>Sample Page</h2>\n  <p>This is a short sample. Try editing and pressing Run.</p>\n  <script>console.log("Hello from sample");</script>\n</body>\n</html>';
        updatePreview();
      });

      // Run on load
      window.addEventListener('load', function(){ updatePreview(); editor.focus(); });

    })();
  </script>
</body>
</html>
